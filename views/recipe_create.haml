#new-recipe.edit-or-create-recipe
  %form
    %label(for = 'recipe-name')< Recipe Name:
    %input#recipe-name.ui-corner-all(placeholder = 'What do you call your recipe?')
    %label(for = "serves")< Serves:
    %input#serves.ui-corner-all(style='width:3em;')
    / %label.ui-state-disabled(for = "meal")< Meal Name:
    / %input#meal.ui-corner-all.ui-state-disabled{:disabled => 'disabled', :placeholder => 'not set'}
    %label(for='description')< Description:
    %textarea#description.ui-corner-all
    %label(for='prep-time')< Preparation Time:
    %input#prep-time-days.ui-corner-all{:style=>'width:2em;margin-right:1em;', :placeholder => 'dd'}
    %input#prep-time-hours.ui-corner-all{:style=>'width:2em;margin-right:1em;', :placeholder => 'hh'}
    %input#prep-time-minutes.ui-corner-all{:style=>'width:2em;', :placeholder => 'mm'}
    %label(for='cooking-time')< Cooking Time:
    %input#cooking-time-days.ui-corner-all{:style=>'width:2em;margin-right:1em;', :placeholder => 'dd'}
    %input#cooking-time-hours.ui-corner-all{:style=>'width:2em;margin-right:1em;', :placeholder => 'hh'}
    %input#cooking-time-minutes.ui-corner-all{:style=>'width:2em;', :placeholder => 'mm'}
    %label(for='requirements')< Requirements
    %textarea#requirements.ui-corner-all
    %label(for='ingredients')< Ingredients
    %table#ingredients
      %thead
        %tr
          %th< Ingredient Name
          %th< Amount
          %th< Unit
      %tbody
    %label(for='method')< Method
    %textarea#method.ui-corner-all
    %label(for='action-bar')< &nbsp;
    %span#action-bar.edit-or-create-recipe
      %input(type='submit' id='choose-photo')
      %input(type='submit' id='preview')
      %input(type='submit' id='create-recipe')
      %input(type='submit' id='cancel')
:javascript
  $(function() {
    // set up three ingredient rows, with appropriate menus and autocomplete handlers
    for (i = 0; i < 3; i++) {
      var i_row = create_blank_ingredients_row(i)
      // console.log(i_row);
      $(i_row).appendTo('#ingredients tbody');
    }
    var allowed_unit_options = #{allowed_units};
    var all_ingredient_names = #{ingredient_names}
    var default_allowed_unit_options = convert_to_options_html(allowed_unit_options);
    
    var ingredient_name_autocompleter = {
      source: all_ingredient_names,
      change: function(){
        var this_row = $(this).parent().parent();
        if (this_row.is(':last-child')) {
          // add another row.
          var new_row_number = this_row.siblings('tr').length + 1;
          $(create_blank_ingredients_row(new_row_number)).appendTo(this_row.parent());
          var new_row = this_row.next();
          $(default_allowed_unit_options).appendTo(new_row.find('.unit-menu'));
          new_row.find('.ingredient').autocomplete(ingredient_name_autocompleter);
        }
      }
    };

    $(default_allowed_unit_options).appendTo('#ingredients .unit-menu');
    $('#ingredients .ingredient').autocomplete(ingredient_name_autocompleter);
    // form handlers.
    var button_names = {
      'choose-photo': "#{Unicode::capitalize(t.ui.choose_photo)}",
      'preview': "#{Unicode::capitalize(t.ui.preview)}",
      'create-recipe': "#{Unicode::capitalize(t.ui.create_recipe)}",
      'cancel': "#{Unicode::capitalize(t.ui.cancel)}"
    }
    var button_handlers = {
      "choose-photo" : function () {
        console.log('choose a recipe photo from your facebook photos.');  // enhance this later
        // see example at http://code.google.com/p/facebook-photo-picker/
        // and a jQuery one at https://github.com/seanhellwig/jQuery-Facebook-Multi-Photo-Selector
      },
      "preview" : function () {
        console.log('preview recipe');  // enhance this later
      },
      "create-recipe" : function () {
        console.log("saving recipe.");
        // go through the form and collect all the fields into a
        // recipe object.
        var ingredients = new Array();
        var number_of_ingredients = $('#ingredients .ingredient').length
        for (i = 0; i < number_of_ingredients ; i++ ) {
          var n = $('#ingredient'+i).val();
          var a = $('#amount'+i).val();
          var u = $('#unit'+i).val();
          if (n != '') {
            q = new Quantity(a, u);
            ingredients.push(new ActiveIngredient(n,q));
          }
        }
        var ct = to_seconds($('#cooking-time-days').val(),
                            $('#cooking-time-hours').val(),
                            $('#cooking-time-minutes').val());
        var pt = to_seconds($('#prep-time-days').val(),
                            $('#prep-time-hours').val(),
                            $('#prep-time-minutes').val());
        var r = new Recipe(0, $('#recipe-name').val(),
                              parseInt($('#serves').val()),
                              ct, pt,
                              $('#description').val(),
                              $('#method').val(),
                              $('#requirements').val(),
                              ingredients, null, null); // ignore tags and meal for now.
        var req = new Recipe_Request(r);
        console.log('created recipe request object to post to ' + req.post_path(), req);
        
        // now fire off an AJAX post to the server.
        $.post(req.post_path(), req.post_data(), function(data){
          console.log('received response data', data);
          
          if (!data['success']) {
            // there was an error.
            console.log('error', data['error']);
            alert("#{t.errors.create_recipe}\r\r" + data['error']);
          } else {
            // there is a message
            console.log('message', data['message']);
            // perhaps do something else with this message.
            //  see also http://stackoverflow.com/questions/1865837/whats-the-difference-between-window-location-and-window-location-replace?lq=1
            location.href = '/';
          }
        }).error(function() {
            alert("#{t.errors.server}");
        });
      },
      "cancel" : function () {
        // check if there have been any changes.
        console.log("Cancel clicked");
        location.href = '/';
      }
    }
    $("input:submit").button({
      create: function(event, ui) {
        $(this).val(button_names[$(this).attr('id')]);
      }
    }).click(function(event) {
      event.preventDefault();
      console.log("click event");
      console.log("event =", event);
      console.log("$(this) =", $(this));
      button_handlers[$(this).attr('id')]();
    });
  });
